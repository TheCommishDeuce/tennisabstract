{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Head to Head Analysis</h2>

<div class="card shadow-sm">
    <div class="card-body">
        <form id="h2hForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="player1" class="form-label">Player 1</label>
                    <input type="text" class="form-control" id="player1" name="player1" 
                           placeholder="e.g., Serena Williams" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="player2" class="form-label">Player 2</label>
                    <input type="text" class="form-control" id="player2" name="player2" 
                           placeholder="e.g., Venus Williams" required>
                </div>
            </div>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-users"></i> View Head to Head
            </button>
        </form>
    </div>
</div>

<div class="loading mt-4">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-2">Fetching match history...</p>
</div>

<div class="alert alert-danger error-message" role="alert"></div>

<div id="results" class="mt-4"></div>
{% endblock %}

{% block extra_js %}
<script>
function getSurfaceClass(surface) {
    const surfaceMap = { 'Hard': 'surface-hard', 'Clay': 'surface-clay', 'Grass': 'surface-grass', 'Carpet': 'surface-hard' };
    return surfaceMap[surface] || 'surface-hard';
}

let h2hProgressChart = null, h2hSurfacesChart = null, h2hRoundsChart = null;

$('#h2hForm').on('submit', function(e) {
    e.preventDefault();
    $('.loading').show();
    $('.error-message').hide();
    $('#results').empty();

    $.ajax({
        url: '/h2h',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            $('.loading').hide();

            const p1 = response.summary.player1;
            const p2 = response.summary.player2;

            // Hero summary
            let summaryHtml = `
                <div class="hero-section text-center mb-4">
                    <h3>${p1} vs ${p2}</h3>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="stat-value">${response.summary.p1_wins}</div>
                            <div class="stat-label text-white-50">${p1} Wins</div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-value">${response.summary.total_matches}</div>
                            <div class="stat-label text-white-50">Total Matches</div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-value">${response.summary.p2_wins}</div>
                            <div class="stat-label text-white-50">${p2} Wins</div>
                        </div>
                    </div>
                </div>
            `;

            // Charts section
            let chartsHtml = `
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-header"><h6 class="mb-0">Cumulative Wins</h6></div>
                            <div class="card-body"><div class="chart-container" style="height: 280px;"><canvas id="h2hProgress"></canvas></div></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-header"><h6 class="mb-0">Wins by Surface</h6></div>
                            <div class="card-body"><div class="chart-container" style="height: 280px;"><canvas id="h2hSurfaces"></canvas></div></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm">
                            <div class="card-header"><h6 class="mb-0">Wins by Round</h6></div>
                            <div class="card-body"><div class="chart-container" style="height: 280px;"><canvas id="h2hRounds"></canvas></div></div>
                        </div>
                    </div>
                </div>
            `;

            // Matches list
            let matchesHtml = `<div class="card shadow-sm"><div class="card-header"><h5 class="mb-0">Match History</h5></div><div class="card-body">`;
            response.matches.forEach((match) => {
                const isP1Winner = match.winner_name === p1;
                matchesHtml += `
                    <div class="match-card">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <small class="text-muted">${match.match_date}</small>
                                <div class="mt-1"><span class="${getSurfaceClass(match.surface)}">${match.surface}</span></div>
                            </div>
                            <div class="col-md-3">
                                <strong>${match.tournament}</strong>
                                <div><small class="text-muted">${match.round}</small></div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="${isP1Winner ? 'player1-value' : 'text-muted'}">${p1} ${isP1Winner ? '<i class="fas fa-trophy text-warning"></i>' : ''}</div>
                                <div class="my-1"><strong>${match.score}</strong></div>
                                <div class="${!isP1Winner ? 'player2-value' : 'text-muted'}">${p2} ${!isP1Winner ? '<i class="fas fa-trophy text-warning"></i>' : ''}</div>
                            </div>
                            <div class="col-md-3 text-end"><span class="badge bg-secondary">${match.h2h}</span></div>
                        </div>
                    </div>
                `;
            });
            matchesHtml += '</div></div>';

            $('#results').html(summaryHtml + chartsHtml + matchesHtml);

            // Build cumulative wins data
            const byDate = [...response.matches].sort((a,b)=> new Date(a.match_date) - new Date(b.match_date));
            let w1 = 0, w2 = 0;
            const labels = [], s1 = [], s2 = [];
            byDate.forEach(m => {
                labels.push(m.match_date);
                if (m.winner_name === p1) w1++; else if (m.winner_name === p2) w2++;
                s1.push(w1); s2.push(w2);
            });

            // Calculate wins by round
            const roundOrder = ['F', 'SF', 'QF', 'R16', 'R32', 'R64', 'R128', 'RR'];
            const roundLabels = {'F': 'Final', 'SF': 'Semi-Final', 'QF': 'Quarter-Final', 'R16': 'Round of 16', 'R32': 'Round of 32', 'R64': 'Round of 64', 'R128': 'Round of 128', 'RR': 'Round Robin'};
            const roundStats = {};
            response.matches.forEach(match => {
                const round = match.round || 'Other';
                if (!roundStats[round]) roundStats[round] = { [p1]: 0, [p2]: 0 };
                if (match.winner_name === p1) roundStats[round][p1]++;
                else if (match.winner_name === p2) roundStats[round][p2]++;
            });
            const sortedRounds = Object.keys(roundStats).sort((a, b) => {
                const aIndex = roundOrder.indexOf(a), bIndex = roundOrder.indexOf(b);
                if (aIndex === -1 && bIndex === -1) return 0;
                if (aIndex === -1) return 1;
                if (bIndex === -1) return -1;
                return aIndex - bIndex;
            });
            const roundLabelsArray = sortedRounds.map(r => roundLabels[r] || r);
            const p1RoundWins = sortedRounds.map(r => roundStats[r][p1] || 0);
            const p2RoundWins = sortedRounds.map(r => roundStats[r][p2] || 0);

            // Destroy old charts
            [h2hProgressChart, h2hSurfacesChart, h2hRoundsChart].forEach(ch => { if (ch && ch.destroy) ch.destroy(); });

            // Cumulative wins chart
            h2hProgressChart = new Chart(document.getElementById('h2hProgress').getContext('2d'), { type: 'line', data: { labels, datasets: [{ label: p1, data: s1, borderColor: 'rgb(30,58,138)', backgroundColor: 'rgba(30,58,138,.1)', tension: .25 }, { label: p2, data: s2, borderColor: 'rgb(239,68,68)', backgroundColor: 'rgba(239,68,68,.1)', tension: .25 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } }, scales: { x: { display: false }, y: { beginAtZero: true, ticks: { precision: 0 } } } } });
            
            // Wins by surface chart
            const surfaces = ['Hard','Clay','Grass','Carpet'];
            const b = response.summary.surface_breakdown || {};
            h2hSurfacesChart = new Chart(document.getElementById('h2hSurfaces').getContext('2d'), { type: 'bar', data: { labels: surfaces, datasets: [{ label: p1, data: surfaces.map(s => (b[s] && b[s][p1]) ? b[s][p1] : 0), backgroundColor: 'rgba(30,58,138,.8)' }, { label: p2, data: surfaces.map(s => (b[s] && b[s][p2]) ? b[s][p2] : 0), backgroundColor: 'rgba(16,185,129,.8)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } } } });
            
            // Wins by round chart
            h2hRoundsChart = new Chart(document.getElementById('h2hRounds').getContext('2d'), { type: 'bar', data: { labels: roundLabelsArray, datasets: [{ label: p1, data: p1RoundWins, backgroundColor: 'rgba(30,58,138,.8)' }, { label: p2, data: p2RoundWins, backgroundColor: 'rgba(245,158,11,.8)' }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 10 } } } } });
        },
        error: function(xhr) {
            $('.loading').hide();
            let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred';
            $('.error-message').text(errorMsg).show();
        }
    });
});
</script>
{% endblock %}
