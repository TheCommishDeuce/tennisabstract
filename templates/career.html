{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Career Statistics</h2>

<div class="card shadow-sm">
    <div class="card-body">
        <form id="careerForm">
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="player" class="form-label">Player Name</label>
                    <input type="text" class="form-control" id="player" name="player" 
                           placeholder="e.g., Roger Federer" required>
                </div>
                <div class="col-md-4 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-warning w-100">
                        <i class="fas fa-trophy"></i> View Career Stats
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="loading mt-4">
    <div class="spinner-border text-warning" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-2">Analyzing career statistics...</p>
</div>

<div class="alert alert-danger error-message" role="alert"></div>

<div id="results" class="mt-4"></div>
{% endblock %}

{% block extra_js %}
<script>
let careerData = null;
let currentYear = null;
let currentSurface = null;
let trendChart = null;

function displayFormString(formString) {
    let html = '';
    for (let i = 0; i < formString.length && i < 10; i++) {
        const result = formString[i];
        html += `<span class="form-badge form-badge-${result === 'W' ? 'win' : 'loss'}">${result}</span>`;
    }
    return html;
}

function displayRecentMatches(matches) {
    let html = '<div class="mt-3">';
    matches.slice(0, 5).forEach(match => {
        const isWin = match.wl === 'W';
        const s = (match.surf || '').toString().toLowerCase();
        html += `
            <div class="recent-match-card recent-match-${isWin ? 'win' : 'loss'}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">${match.date}</small>
                        <span class="ms-2">${match.tourn}</span>
                        <span class="badge bg-secondary ms-1">${match.round}</span>
                    </div>
                    <div class="text-end">
                        <span class="surface-${s}">${match.surf || '-'}</span>
                        <span class="ms-2">${isWin ? 'def.' : 'lost to'} ${match.opp}</span>
                        <strong class="ms-2">${match.score}</strong>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    return html;
}

function displayYearStats(year, surface = null) {
    currentYear = year;
    $('.year-btn').removeClass('active');
    $(`.year-btn[data-year="${year}"]`).addClass('active');

    let displayData;
    if (surface && surface !== 'All') {
        if (!careerData.surface_breakdown[surface]) {
            $('#yearStats').html(`<div class="alert alert-warning">No ${surface} court data available ${year === 'career' ? '' : 'for ' + year}.</div>`);
            updateTrendChart(surface);
            return;
        }
        displayData = (year === 'career') ? careerData.surface_breakdown[surface].career : careerData.surface_breakdown[surface].yearly[year];
        if (!displayData) {
            $('#yearStats').html(`<div class="alert alert-warning">No ${surface} court data available for ${year}.</div>`);
            updateTrendChart(surface);
            return;
        }
    } else {
        displayData = year === 'career' ? careerData.career_summary : careerData.yearly_stats.find(y => y.year == year);
    }
    if (!displayData) return;

    let surfaceIndicator = '';
    if (surface && surface !== 'All') {
        surfaceIndicator = `<div class="alert alert-info mb-3"><i class="fas fa-filter"></i> Showing ${surface} court statistics ${year === 'career' ? '(Career)' : 'for ' + year}</div>`;
    }

    let statsHtml = surfaceIndicator + `
        <div class="row mb-4">
            <div class="col-md-3"><div class="stat-card text-center"><div class="stat-label">Win-Loss Record</div><div class="stat-value">${displayData['W-L'] || 'N/A'}</div><div class="text-muted">${displayData['win%'] || '0'}% Win Rate</div></div></div>
            <div class="col-md-3"><div class="stat-card text-center"><div class="stat-label">1st Serve %</div><div class="stat-value">${displayData['1st_in%'] || 'N/A'}%</div></div></div>
            <div class="col-md-3"><div class="stat-card text-center"><div class="stat-label">1st Serve Win %</div><div class="stat-value">${displayData['1st_win%'] || 'N/A'}%</div></div></div>
            <div class="col-md-3"><div class="stat-card text-center"><div class="stat-label">Break %</div><div class="stat-value">${displayData['break%'] || 'N/A'}%</div></div></div>
        </div>
    `;

    if (careerData.recent_form && careerData.recent_form.matches && careerData.recent_form.matches.length > 0 && year === 'career') {
        statsHtml += `<div class="card shadow-sm mb-4"><div class="card-header bg-light"><strong><i class="fas fa-history"></i> Recent Matches</strong></div><div class="card-body">${displayRecentMatches(careerData.recent_form.matches)}</div></div>`;
    }

    statsHtml += `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="fas fa-bolt"></i> Serve Statistics</h6></div>
                    <div class="card-body">
                        <div class="stat-comparison-row"><div class="stat-name">1st Serve %</div><div class="stat-value-display">${displayData['1st_in%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">1st Serve Win %</div><div class="stat-value-display">${displayData['1st_win%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">2nd Serve Win %</div><div class="stat-value-display">${displayData['2nd_win%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Ace %</div><div class="stat-value-display">${displayData['ace%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Double Fault %</div><div class="stat-value-display">${displayData['df%'] || 'N/A'}%</div></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white"><h6 class="mb-0"><i class="fas fa-gamepad"></i> Games Statistics</h6></div>
                    <div class="card-body">
                        <div class="stat-comparison-row"><div class="stat-name">Hold %</div><div class="stat-value-display">${displayData['hold%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Break Points Saved %</div><div class="stat-value-display">${displayData['bp_saved%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Break %</div><div class="stat-value-display">${displayData['break%'] || 'N/A'}%</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Tiebreak</div><div class="stat-value-display">${displayData['tb_W-L'] ? `${displayData['tb_W-L']} (${displayData['tb_win%'] || 'N/A'}%)` : displayData['tb_win%'] ? `${displayData['tb_win%']}%` : 'N/A'}</div></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-warning text-white"><h6 class="mb-0"><i class="fas fa-trophy"></i> Match Statistics</h6></div>
                    <div class="card-body">
                        <!-- *** MODIFICATION START *** -->
                        <div class="stat-comparison-row"><div class="stat-name">vs Top 5</div><div class="stat-value-display">${displayData['top5_W-L'] ? `${displayData['top5_W-L']} (${displayData['top5_win%'] || 'N/A'}%)` : (displayData['top5_win%'] ? `${displayData['top5_win%']}%` : 'N/A')}</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">vs Top 10</div><div class="stat-value-display">${displayData['top10_W-L'] ? `${displayData['top10_W-L']} (${displayData['top10_win%'] || 'N/A'}%)` : (displayData['top10_win%'] ? `${displayData['top10_win%']}%` : 'N/A')}</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">vs Top 20</div><div class="stat-value-display">${displayData['top20_W-L'] ? `${displayData['top20_W-L']} (${displayData['top20_win%'] || 'N/A'}%)` : (displayData['top20_win%'] ? `${displayData['top20_win%']}%` : 'N/A')}</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">vs Top 50</div><div class="stat-value-display">${displayData['top50_W-L'] ? `${displayData['top50_W-L']} (${displayData['top50_win%'] || 'N/A'}%)` : (displayData['top50_win%'] ? `${displayData['top50_win%']}%` : 'N/A')}</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">vs Top 100</div><div class="stat-value-display">${displayData['top100_W-L'] ? `${displayData['top100_W-L']} (${displayData['top100_win%'] || 'N/A'}%)` : (displayData['top100_win%'] ? `${displayData['top100_win%']}%` : 'N/A')}</div></div>
                        <div class="stat-comparison-row"><div class="stat-name">Avg Opponent Rank</div><div class="stat-value-display">${displayData['avg_opp_rank'] || 'N/A'}</div></div>
                        <!-- *** MODIFICATION END *** -->
                    </div>
                </div>
            </div>
        </div>
    `;

    $('#yearStats').html(statsHtml);
    updateTrendChart(surface);
}

$(document).on('click', '#surfaceFilter button', function() {
    $('#surfaceFilter button').removeClass('active');
    $(this).addClass('active');
    currentSurface = $(this).data('surface');
    displayYearStats(currentYear, currentSurface);
});

$('#careerForm').on('submit', function(e) {
    e.preventDefault();
    $('.loading').show();
    $('.error-message').hide();
    $('#results').empty();

    $.ajax({
        url: '/career',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            $('.loading').hide();
            careerData = response;
            currentYear = 'career';
            currentSurface = 'All';

            let heroHtml = `
                <div class="hero-section mb-4">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h3 class="display-5">${response.player}</h3>
                                <div class="row mt-4">
                                    <div class="col-md-4"><div class="stat-label">Career Record</div><div class="stat-value">${response.career_summary['W-L']}</div><p class="mb-0">${response.career_summary['win%']}% Win Rate</p></div>
                                    <div class="col-md-4"><div class="stat-label">Avg Opponent Rank</div><div class="stat-value">${response.career_summary['avg_opp_rank']}</div></div>
                                    <div class="col-md-4"><div class="stat-label">Years on Tour</div><div class="stat-value">${response.yearly_stats.length}</div></div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-white bg-opacity-10 border-0">
                                    <div class="card-body">
                                        <h5 class="text-white mb-3">Recent Form</h5>
                                        <div class="mb-3">${displayFormString(response.recent_form.form_string)}</div>
                                        <p class="mb-2">Last ${response.recent_form.last_matches}: <strong>${response.recent_form.wins}-${response.recent_form.losses}</strong> (${response.recent_form.win_pct}%)</p>
                                        ${response.recent_form.win_streak > 1 ? `<p class="mb-0 streak-text streak-win"><i class="fas fa-fire"></i> ${response.recent_form.win_streak} match win streak</p>` : response.recent_form.loss_streak > 1 ? `<p class="mb-0 streak-text streak-loss"><i class="fas fa-arrow-down"></i> ${response.recent_form.loss_streak} match losing streak</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            let contentHtml = '<div class="mb-4">';
            contentHtml += '<div class="d-flex justify-content-between align-items-center mb-3"><div class="year-nav">';
            contentHtml += '<button class="year-btn active" data-year="career" onclick="displayYearStats(\'career\', currentSurface)">Career</button>';
            const sortedYears = response.yearly_stats.map(y => y.year).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                contentHtml += `<button class="year-btn" data-year="${year}" onclick="displayYearStats(${year}, currentSurface)">${year}</button>`;
            });
            contentHtml += '</div></div>';
            contentHtml += `<div id="surfaceFilter"><div class="btn-group" role="group"><button type="button" class="btn btn-outline-primary active" data-surface="All">All Surfaces</button>`;
            const availableSurfaces = Object.keys(response.surface_breakdown || {});
            availableSurfaces.forEach(surface => {
                contentHtml += `<button type="button" class="btn btn-outline-primary" data-surface="${surface}">${surface}</button>`;
            });
            contentHtml += '</div></div></div>';
            contentHtml += '<div id="yearStats"></div>';
            
            // *** MODIFICATION: Changed header to bg-dark text-white ***
            contentHtml += `
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-dark text-white"><strong><i class="fas fa-chart-line"></i> Performance Trend</strong></div>
                    <div class="card-body"><div class="chart-container" style="height: 400px;"><canvas id="trendChart"></canvas></div></div>
                </div>
            `;

            $('#results').html(heroHtml + contentHtml);
            setTimeout(() => { displayYearStats('career', 'All'); }, 100);
        },
        error: function(xhr) {
            $('.loading').hide();
            let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred';
            $('.error-message').text(errorMsg).show();
        }
    });
});

function updateTrendChart(surface) {
    if (!careerData) return;
    const canvasEl = document.getElementById('trendChart');
    if (!canvasEl || typeof Chart === 'undefined') return;

    let years = [], winPcts = [], holdPcts = [], breakPcts = [];
    if (!surface || surface === 'All' || !careerData.surface_breakdown?.[surface]) {
        const validYearlyStats = (careerData.yearly_stats || []).filter(y => y && y.year && !isNaN(y.year));
        if (validYearlyStats.length === 0) {
            $('#trendChart').parent().html('<p class="text-muted text-center">No trend data available</p>');
            return;
        }
        years = validYearlyStats.map(y => y.year).sort((a, b) => a - b);
        winPcts = years.map(yr => _stripPct(validYearlyStats.find(y => y.year == yr)?.['win%']));
        holdPcts = years.map(yr => _stripPct(validYearlyStats.find(y => y.year == yr)?.['hold%']));
        breakPcts = years.map(yr => _stripPct(validYearlyStats.find(y => y.year == yr)?.['break%']));
    } else {
        const yearlyObj = careerData.surface_breakdown[surface].yearly || {};
        years = Object.keys(yearlyObj).map(n => parseInt(n, 10)).filter(y => !isNaN(y)).sort((a, b) => a - b);
        if (years.length === 0) {
            $('#trendChart').parent().html('<p class="text-muted text-center">No trend data available for ' + surface + '</p>');
            return;
        }
        winPcts = years.map(yr => _stripPct(yearlyObj[yr]?.['win%']));
        holdPcts = years.map(yr => _stripPct(yearlyObj[yr]?.['hold%']));
        breakPcts = years.map(yr => _stripPct(yearlyObj[yr]?.['break%']));
    }

    const datasets = [{ label: 'Win %', data: winPcts, borderColor: 'rgb(30,58,138)', backgroundColor: 'rgba(30,58,138,.1)', tension: 0.3 }];
    if (holdPcts.some(v => v !== null)) datasets.push({ label: 'Hold %', data: holdPcts, borderColor: 'rgb(16,185,129)', backgroundColor: 'rgba(16,185,129,.1)', tension: 0.3, spanGaps: true });
    if (breakPcts.some(v => v !== null)) datasets.push({ label: 'Break %', data: breakPcts, borderColor: 'rgb(239,68,68)', backgroundColor: 'rgba(239,68,68,.1)', tension: 0.3, spanGaps: true });

    if (trendChart) trendChart.destroy();
    trendChart = new Chart(canvasEl.getContext('2d'), {
        type: 'line',
        data: { labels: years, datasets },
        options: {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            scales: { y: { min: 0, max: 100, title: { display: true, text: 'Percentage (%)' } }, x: { title: { display: true, text: 'Year' } } },
            plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (ctx) => ctx.parsed.y !== null ? `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%` : null } } }
        }
    });
}
function _stripPct(val) { if (val === null || val === undefined) return null; const num = parseFloat(val); return isFinite(num) ? num : null; }
</script>
{% endblock %}
