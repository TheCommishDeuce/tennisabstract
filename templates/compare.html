{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Player Comparison</h2>

<div class="card shadow-sm">
    <div class="card-body">
        <form id="compareForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="player1" class="form-label">Player 1</label>
                    <input type="text" class="form-control" id="player1" name="player1" 
                           placeholder="e.g., Novak Djokovic" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="player2" class="form-label">Player 2</label>
                    <input type="text" class="form-control" id="player2" name="player2" 
                           placeholder="e.g., Rafael Nadal" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="year" class="form-label">Year</label>
                    <select class="form-control" id="year" name="year">
                        {% for year in range(current_year, 1999, -1) %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-chart-bar"></i> Compare Players
            </button>
        </form>
    </div>
</div>

<div class="loading mt-4">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-2">Analyzing player statistics...</p>
</div>

<div class="alert alert-danger error-message" role="alert"></div>

<div id="surfaceFilter" class="mt-4" style="display: none;">
    <div class="btn-group" role="group"></div>
</div>

<div id="results" class="mt-4"></div>
{% endblock %}

{% block extra_js %}
<script>
let allSurfacesData = null;
let currentSurface = 'All';
let performanceChart = null;

// Helper: better stat direction
function isBetterValue(stat, val1, val2) {
    const lowerIsBetter = ['df%', 'losses', 'avg_opp_rank'];
    if (lowerIsBetter.includes(stat)) return (parseFloat(val1) || 0) < (parseFloat(val2) || 0);
    return (parseFloat(val1) || 0) > (parseFloat(val2) || 0);
}

// Helper: friendly labels
function formatStatName(stat) {
    const statNames = {
        'W-L': 'Win-Loss Record',
        'win%': 'Win Percentage',
        'ace%': 'Ace Percentage',
        'df%': 'Double Fault %',
        '1st_in%': '1st Serve In %',
        '1st_win%': '1st Serve Win %',
        '2nd_win%': '2nd Serve Win %',
        'bp_saved%': 'Break Points Saved %',
        'hold%': 'Service Hold %',
        'break%': 'Break Percentage',
        'avg_opp_rank': 'Avg Opponent Rank',
        'matches_with_stats%': 'Matches with Stats %',
        'tb_W-L': 'Tiebreak W-L',
        'tb_win%': 'Tiebreak Win %',
        'top5_win%': 'Win% vs Top 5',
        'top10_win%': 'Win% vs Top 10',
        'top20_win%': 'Win% vs Top 20',
        'top50_win%': 'Win% vs Top 50',
        'top100_win%': 'Win% vs Top 100'
    };
    return statNames[stat] || stat;
}

// Surface filter click handler
$(document).on('click', '#surfaceFilter button', function() {
    $('#surfaceFilter button').removeClass('active');
    $(this).addClass('active');
    currentSurface = $(this).data('surface');
    displayComparison(currentSurface);
});

function getStat(statsData, key) {
    const row = statsData.find(s => s.stat === key);
    if (!row) return { p1: null, p2: null, names: null };
    return {
        p1: parseFloat(row.player1_value) || 0,
        p2: parseFloat(row.player2_value) || 0,
        p1_raw: row.player1_value,
        p2_raw: row.player2_value,
        names: { p1: row.player1_name, p2: row.player2_name }
    };
}

function displayComparison(surface) {
    const statsData = allSurfacesData[surface];
    if (!statsData || !statsData.length) {
        $('#results').html(`
            <div class="alert alert-warning">
                No data available for ${surface} surface in the selected year.
            </div>
        `);
        return;
    }

    const player1 = statsData[0].player1_name;
    const player2 = statsData[0].player2_name;

    let surfaceIndicator = '';
    if (surface !== 'All') {
        surfaceIndicator = `<div class="alert alert-info mb-3">
            <i class="fas fa-filter"></i> Showing statistics for <strong>${surface}</strong> court only
        </div>`;
    }

    // Overview cards with W-L and win%
    const wlStat = getStat(statsData, 'W-L');
    const winPctStat = getStat(statsData, 'win%');
    
    let overviewHtml = `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5 class="text-primary mb-3">${player1}</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="stat-label">Record</span>
                        <span class="stat-value">${wlStat.p1_raw || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="stat-label">Win %</span>
                        <span class="stat-value">${winPctStat.p1_raw || 'N/A'}%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <h5 class="text-success mb-3">${player2}</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="stat-label">Record</span>
                        <span class="stat-value">${wlStat.p2_raw || 'N/A'}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="stat-label">Win %</span>
                        <span class="stat-value">${winPctStat.p2_raw || 'N/A'}%</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Detailed stats in three columns
    let detailsHtml = `
        <div class="row mb-4">
            <!-- Serve Stats -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-bolt"></i> Serve Statistics</h6>
                    </div>
                    <div class="card-body">
    `;
    
    const serveStats = ['1st_in%', '1st_win%', '2nd_win%', 'ace%', 'df%'];
    serveStats.forEach(stat => {
        const row = statsData.find(s => s.stat === stat);
        if (row) {
            const p1Better = isBetterValue(stat, row.player1_value, row.player2_value);
            detailsHtml += `
                <div class="stat-comparison-row">
                    <div class="stat-name">${formatStatName(stat)}</div>
                    <div class="stat-values">
                        <span class="player1-value ${p1Better ? 'better' : ''}">${row.player1_value || 'N/A'}</span>
                        <span class="vs-separator">vs</span>
                        <span class="player2-value ${!p1Better ? 'better' : ''}">${row.player2_value || 'N/A'}</span>
                    </div>
                </div>
            `;
        }
    });
    
    detailsHtml += `
                    </div>
                </div>
            </div>
            
            <!-- Games Stats -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-gamepad"></i> Games Statistics</h6>
                    </div>
                    <div class="card-body">
    `;
    
    // In the Games Stats section, replace the tiebreak line with:
    const gameStats = ['hold%', 'bp_saved%', 'break%', 'tb_win%'];
    gameStats.forEach(stat => {
        const row = statsData.find(s => s.stat === stat);
        if (row) {
            const p1Better = isBetterValue(stat, row.player1_value, row.player2_value);
            
            // Special handling for tiebreak to show both W-L and %
            if (stat === 'tb_win%') {
                const tbWL = statsData.find(s => s.stat === 'tb_W-L');
                const p1Display = tbWL && tbWL.player1_value ? 
                    `${tbWL.player1_value} (${row.player1_value || 'N/A'})` : 
                    row.player1_value || 'N/A';
                const p2Display = tbWL && tbWL.player2_value ? 
                    `${tbWL.player2_value} (${row.player2_value || 'N/A'})` : 
                    row.player2_value || 'N/A';
                
                detailsHtml += `
                    <div class="stat-comparison-row">
                        <div class="stat-name">Tiebreak</div>
                        <div class="stat-values">
                            <span class="player1-value ${p1Better ? 'better' : ''}">${p1Display}</span>
                            <span class="vs-separator">vs</span>
                            <span class="player2-value ${!p1Better ? 'better' : ''}">${p2Display}</span>
                        </div>
                    </div>
                `;
            } else {
                detailsHtml += `
                    <div class="stat-comparison-row">
                        <div class="stat-name">${stat === 'hold%' ? 'Hold %' : 
                                            stat === 'bp_saved%' ? 'Break Points Saved %' :
                                            'Break %'}</div>
                        <div class="stat-values">
                            <span class="player1-value ${p1Better ? 'better' : ''}">${row.player1_value || 'N/A'}</span>
                            <span class="vs-separator">vs</span>
                            <span class="player2-value ${!p1Better ? 'better' : ''}">${row.player2_value || 'N/A'}</span>
                        </div>
                    </div>
                `;
            }
        }
    });

    
    detailsHtml += `
                    </div>
                </div>
            </div>
            
            <!-- Match Stats -->
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0"><i class="fas fa-trophy"></i> Match Statistics</h6>
                    </div>
                    <div class="card-body">
    `;
    
    const matchStats = ['top5_win%', 'top10_win%', 'top20_win%', 'top50_win%', 'top100_win%', 'avg_opp_rank'];
    matchStats.forEach(stat => {
        const row = statsData.find(s => s.stat === stat);
        if (row) {
            const p1Better = isBetterValue(stat, row.player1_value, row.player2_value);
            const label = stat === 'avg_opp_rank' ? 'Avg Opponent Rank' : 
                         stat.replace('_win%', '').replace('top', 'vs Top ');
            detailsHtml += `
                <div class="stat-comparison-row">
                    <div class="stat-name">${label}</div>
                    <div class="stat-values">
                        <span class="player1-value ${p1Better ? 'better' : ''}">${row.player1_value || 'N/A'}</span>
                        <span class="vs-separator">vs</span>
                        <span class="player2-value ${!p1Better ? 'better' : ''}">${row.player2_value || 'N/A'}</span>
                    </div>
                </div>
            `;
        }
    });
    
    detailsHtml += `
                    </div>
                </div>
            </div>
        </div>
    `;

    // Performance comparison chart
    const winPct = getStat(statsData, 'win%');
    const hold = getStat(statsData, 'hold%');
    const brk = getStat(statsData, 'break%');

    let chartHtml = `
        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h5 class="mb-0">Performance Comparison</h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    `;

    $('#results').html(surfaceIndicator + overviewHtml + detailsHtml + chartHtml);

    // Destroy existing chart
    if (performanceChart && performanceChart.destroy) performanceChart.destroy();

    // Create performance comparison chart
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Win %', 'Hold %', 'Break %'],
            datasets: [{
                label: player1,
                data: [winPct.p1 || 0, hold.p1 || 0, brk.p1 || 0],
                backgroundColor: 'rgba(30,58,138,.7)',
                borderColor: 'rgb(30,58,138)',
                borderWidth: 1
            }, {
                label: player2,
                data: [winPct.p2 || 0, hold.p2 || 0, brk.p2 || 0],
                backgroundColor: 'rgba(16,185,129,.7)',
                borderColor: 'rgb(16,185,129)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            }
        }
    });
}

$('#compareForm').on('submit', function(e) {
    e.preventDefault();
    $('.loading').show();
    $('.error-message').hide();
    $('#results').empty();
    $('#surfaceFilter').hide();

    $.ajax({
        url: '/compare',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            $('.loading').hide();
            allSurfacesData = response.all_surfaces_stats;

            const available = Object.keys(allSurfacesData).filter(s => allSurfacesData[s] && allSurfacesData[s].length);
            const btns = available.map((s, i) => `
                <button type="button" class="btn btn-outline-primary ${i===0?'active':''}" data-surface="${s}">${s}</button>
            `).join('');
            $('#surfaceFilter .btn-group').html(btns);
            $('#surfaceFilter').show();

            if (available.length) {
                currentSurface = available[0];
                displayComparison(currentSurface);
            }
        },
        error: function(xhr) {
            $('.loading').hide();
            let errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'An error occurred';
            $('.error-message').text(errorMsg).show();
        }
    });
});
</script>
{% endblock %}
